name: Build NSIS Test (Settings Import)

# Manual trigger for testing NSIS changes
on:
  workflow_dispatch:
    inputs:
      debug:
        description: 'Enable debug mode'
        required: false
        default: 'false'

jobs:
  build:
    runs-on: windows-latest

    defaults:
      run:
        shell: msys2 {0}

    steps:
      - name: Checkout WSJT-X repository
        uses: actions/checkout@v4
        with:
          path: wsjtx

      - name: Disable Windows Defender
        shell: pwsh
        run: |
          Set-MpPreference -DisableRealtimeMonitoring $true

      - name: Setup MSYS2 and dependencies
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: false
          cache: true
          install: >-
            git
            make
            mingw-w64-x86_64-cmake
            pkg-config
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-gcc-fortran
            mingw-w64-x86_64-libusb
            mingw-w64-x86_64-fftw
            mingw-w64-x86_64-omp
            mingw-w64-x86_64-qt5
            mingw-w64-x86_64-qt5-multimedia
            mingw-w64-x86_64-qt5-serialport
            mingw-w64-x86_64-qt5-tools
            mingw-w64-x86_64-boost
            mingw-w64-x86_64-portaudio
            mingw-w64-x86_64-nsis

      - name: Download Hamlib and OmniRig
        shell: pwsh
        run: |
          # Download files sequentially (parallel jobs unreliable in CI)
          curl -L -o C:\hamlib.zip "https://github.com/SensorsIot/hamlib-prebuilds/releases/download/hamlib-4.6.5/hamlib-mingw64-4.6.5.zip"
          Invoke-WebRequest -Uri "https://www.dxatlas.com/OmniRig/Files/OmniRig.zip" -OutFile "C:\OmniRig.zip"
          Invoke-WebRequest -Uri "http://dxatlas.com/OmniRig/Files/RigIni.zip" -OutFile "C:\RigIni.zip"

          # Extract Hamlib
          Expand-Archive -Path "C:\hamlib.zip" -DestinationPath "C:\hamlib-prefix"

          # Install OmniRig
          Expand-Archive -Path "C:\OmniRig.zip" -DestinationPath "C:\OmniRig"
          Start-Process -FilePath "C:\OmniRig\OmniRigSetup.exe" -ArgumentList "/VERYSILENT /SUPPRESSMSGBOXES /NORESTART" -Wait

          # Install OmniRig INI files
          Expand-Archive -Path "C:\RigIni.zip" -DestinationPath "C:\OmniRigIni"
          $omniRigRigsPath = "C:\Program Files (x86)\Afreet\OmniRig\Rigs"
          if (-not (Test-Path $omniRigRigsPath)) {
              New-Item -Path $omniRigRigsPath -ItemType Directory -Force
          }
          Copy-Item -Path "C:\OmniRigIni\*.ini" -Destination $omniRigRigsPath -Force

      - name: Create test WSJT-X.ini file
        shell: pwsh
        run: |
          # Create a test ini file that simulates a user's WSJT-X configuration
          $iniContent = @"
[General]
MyCall=HB9TEST
MyGrid=JN47
"@
          New-Item -Path "C:\wsjtx" -ItemType Directory -Force
          Set-Content -Path "C:\wsjtx\WSJT-X.ini" -Value $iniContent
          Write-Host "Created test WSJT-X.ini at C:\wsjtx\WSJT-X.ini"
          Get-Content "C:\wsjtx\WSJT-X.ini"

      - name: Use test CPack options
        shell: pwsh
        run: |
          Copy-Item -Path "wsjtx/CMakeCPackOptions-nsis-test.cmake.in" -Destination "wsjtx/CMakeCPackOptions.cmake.in" -Force
          Write-Host "Replaced CMakeCPackOptions.cmake.in with test version"

      - name: Configure WSJT-X
        run: |
          cd wsjtx
          mkdir -p build
          cd build
          export HAMLIB_PREFIX="/c/hamlib-prefix"
          cmake -G "MinGW Makefiles" \
                -D CMAKE_BUILD_TYPE=Release \
                -D CMAKE_PREFIX_PATH="${HAMLIB_PREFIX}" \
                -D Hamlib_INCLUDE_DIR="${HAMLIB_PREFIX}/include" \
                -D Hamlib_LIBRARY="${HAMLIB_PREFIX}/lib/libhamlib.dll.a" \
                -D hamlib_STATIC=0 \
                -D CMAKE_Fortran_FLAGS="-fallow-argument-mismatch" \
                -DWSJT_SKIP_MANPAGES=ON \
                -DWSJT_GENERATE_DOCS=OFF \
                -D CMAKE_INSTALL_PREFIX="/c/wsjtx-install" \
                ..

      - name: Build WSJT-X
        run: |
          cd wsjtx/build
          cmake --build . --config Release --parallel 4

      - name: Install and bundle WSJT-X
        run: |
          cd wsjtx/build
          # cmake install runs fixup_bundle() which copies all required DLLs
          cmake --build . --target install --config Release

      - name: Create NSIS installer
        run: |
          cd wsjtx/build
          cpack -G NSIS || (cat _CPack_Packages/win64/NSIS/NSISOutput.log && exit 1)

      - name: Create ZIP archive
        shell: pwsh
        run: |
          $installer = Get-ChildItem -Path "wsjtx/build/wsjtx-*.exe" | Select-Object -First 1
          $zipName = "wsjtx-swiss-" + $installer.BaseName.Replace("wsjtx-", "") + ".zip"
          Compress-Archive -Path $installer.FullName -DestinationPath "wsjtx/build/$zipName"

      - name: Upload installer
        uses: actions/upload-artifact@v4
        with:
          name: wsjtx-swiss-nsis-test
          path: wsjtx/build/wsjtx-swiss-*.zip
          compression-level: 0
          retention-days: 7

      - name: Upload NSIS script for debugging
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nsis-debug
          path: wsjtx/build/_CPack_Packages/win64/NSIS/
          retention-days: 7
